<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>租赁合同</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            padding: 15px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        h1 {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 25px 0 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        h3 {
            font-size: 16px;
            font-weight: 700;
            margin: 20px 0 10px;
            color: #34495e;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            vertical-align: top;
            word-wrap: break-word;
        }
        th {
            background-color: #f5f5f5;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="text"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
            background: #fff;
            overflow: visible;
            height: auto;
            min-height: 40px;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }
        /* 签名板核心样式 - 修复渲染问题 */
        .signature-pad {
            width: 100%;
            height: 180px; /* 增加高度提升体验 */
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            background: #fff;
            cursor: crosshair;
            position: relative;
            z-index: 10; /* 确保签名板在最上层 */
            overflow: hidden;
            touch-action: none; /* 禁用触摸默认行为 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .signature-pad:active {
            cursor: crosshair;
        }
        /* 签名提示文字 */
        .signature-hint {
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            text-align: center;
            transform: translateY(-50%);
            color: #999;
            font-size: 14px;
            pointer-events: none;
            z-index: 5;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        .btn-primary {
            background-color: #3498db;
            color: #fff;
        }
        .btn-success {
            background-color: #2ecc71;
            color: #fff;
        }
        .btn-warning {
            background-color: #f39c12;
            color: #fff;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            transition: all 0.3s;
        }
        .date-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .date-group > div {
            flex: 1;
            min-width: 150px;
        }
        .note {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .section {
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }
        .signature-container {
            margin: 30px 0;
            position: relative;
            z-index: 2;
        }
        .signature-row {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 30px;
        }
        .signature-col {
            flex: 1;
            position: relative;
        }
        @media print {
            body {
                background: #fff;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 20px;
                margin: 0;
                width: 100%;
            }
            .btn-group {
                display: none;
            }
            .signature-pad {
                border: 1px solid #333;
            }
            .signature-hint {
                display: none;
            }
            input[type="text"],
            input[type="tel"],
            input[type="number"],
            input[type="date"],
            textarea {
                border: none;
                padding: 5px;
                font-size: 13px;
                color: #000;
            }
            @page {
                margin: 1.5cm;
                size: A4;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            h1 {
                font-size: 20px;
            }
            h2 {
                font-size: 16px;
            }
            h3 {
                font-size: 15px;
            }
            th, td {
                padding: 8px;
                font-size: 13px;
            }
            .date-group {
                flex-direction: column;
                gap: 15px;
            }
            .btn-group {
                flex-direction: column;
            }
            .signature-pad {
                height: 150px;
            }
            input[type="text"],
            input[type="tel"],
            input[type="number"],
            input[type="date"],
            textarea {
                padding: 8px;
                font-size: 13px;
            }
        }
        .inline-input-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        .inline-input {
            width: auto !important;
            min-width: 80px !important;
            display: inline-block !important;
        }
    </style>
</head>
<body>
    <div class="container" id="contract-content">
        <h1>租赁合同</h1>

        <!-- 甲乙双方信息表 -->
        <table>
            <tr>
                <th>甲方（出租方 / 房东）</th>
                <th>乙方（承租方 / 租客）</th>
            </tr>
            <tr>
                <td>
                    <div class="form-group">
                        <label>姓名 / 名称：</label>
                        <input type="text" id="partyA-name" placeholder="请输入甲方姓名/名称">
                    </div>
                    <div class="form-group">
                        <label>联系电话：</label>
                        <input type="tel" id="partyA-tel" placeholder="请输入甲方联系电话">
                    </div>
                </td>
                <td>
                    <div class="form-group">
                        <label>姓名 / 名称：</label>
                        <input type="text" id="partyB-name" placeholder="请输入乙方姓名/名称">
                    </div>
                    <div class="form-group">
                        <label>身份证号 / 统一社会信用代码：</label>
                        <input type="text" id="partyB-id" placeholder="请输入身份证号/统一社会信用代码">
                    </div>
                    <div class="form-group">
                        <label>联系电话：</label>
                        <input type="tel" id="partyB-tel" placeholder="请输入乙方联系电话">
                    </div>
                    <div class="form-group">
                        <label>紧急联系人及电话：</label>
                        <input type="text" id="partyB-emergency" placeholder="请输入紧急联系人及电话">
                    </div>
                    <div class="form-group">
                        <label>实际居住人信息（含共同居住人）：</label>
                        <textarea id="partyB-residents" rows="2" placeholder="请输入实际居住人信息（附身份证复印件）"></textarea>
                    </div>
                </td>
            </tr>
        </table>

        <h3>引言</h3>
        <p>本条款依据《中华人民共和国民法典》第七百零三条至七百三十四条等相关法律法规拟定，明确房屋租赁双方权利义务，确保本合同合法有效，对双方具有法律约束力。</p>

        <!-- 第一条 租赁标的 -->
        <div class="section">
            <h2>第一条 租赁标的</h2>
            <div class="form-group">
                <div class="inline-input-group">
                    <label>1. 甲方将</label>
                    <input type="text" id="apartment-name" placeholder="请输入公寓名称" class="inline-input">
                    <label>公寓</label>
                    <input type="text" id="room-number" placeholder="请输入房号" class="inline-input" style="min-width: 60px !important;">
                    <label>室出租给乙方。</label>
                </div>
            </div>
            <div class="form-group">
                <label>2. 该房屋用途：</label>
                <p>1. 仅限乙方本人（及共同居住人）居住使用。</p>
                <p>2. 乙方不得擅自改变用途，不得转租、转借、分租给第三方。</p>
                <p>3. 不得作为办公、经营、仓储等非居住用途。</p>
            </div>
        </div>

        <!-- 第二条 租赁期限 -->
        <div class="section">
            <h2>第二条 租赁期限</h2>
            <div class="date-group">
                <div>
                    <label>1. 租赁期限自：</label>
                    <input type="date" id="lease-start" class="lease-date">
                </div>
                <div>
                    <label>起至：</label>
                    <input type="date" id="lease-end" class="lease-date">
                </div>
            </div>
            <div class="form-group">
                <div class="inline-input-group">
                    <label>共计：</label>
                    <input type="number" id="lease-months" placeholder="请输入租赁月数" class="inline-input" style="min-width: 60px !important;">
                    <label>个月。</label>
                </div>
            </div>
            <p>2. 租赁期满，乙方若需续租，应提前 30 日通知甲方，否则视为续租按上一期合同继续生效。若甲方不同意续租，乙方应于租赁期满当日腾空房屋并办理交接；若乙方逾期未搬离，视为违约，每逾期一日按日租金的 3 倍向甲方支付占用费，同时甲方有权强制清退，产生的费用（含开锁费、搬运费、仓储费等）由乙方承担。</p>
        </div>

        <!-- 第三条 租金、押金及支付方式 -->
        <div class="section">
            <h2>第三条 租金、押金及支付方式</h2>
            <div class="form-group">
                <div class="inline-input-group">
                    <label>1. 租金标准：每月人民币</label>
                    <input type="number" id="monthly-rent" placeholder="0" class="inline-input" style="min-width: 80px !important;">
                    <label>元，管理费</label>
                    <input type="number" id="management-fee" placeholder="0" class="inline-input" style="min-width: 80px !important;">
                    <label>元，租金不含水、电、燃气、物业、宽带、有线电视等其他费用。</label>
                </div>
            </div>
            <p>2. 支付方式：乙方应在每月1日支付至甲方指定账户，首期租金于本合同签订当日支付。</p>
            <div class="form-group">
                <div class="inline-input-group">
                    <label>3. 押金：乙方应于签订本合同当日支付人民币</label>
                    <input type="number" id="deposit" placeholder="0" class="inline-input" style="min-width: 80px !important;">
                    <label>元作为押金，门卡押金</label>
                    <input type="number" id="card-deposit" placeholder="0" class="inline-input" style="min-width: 60px !important;">
                    <label>元，空调遥控器押金</label>
                    <input type="number" id="remote-deposit" placeholder="0" class="inline-input" style="min-width: 60px !important;">
                    <label>元，租赁期满后，经甲方验收房屋及附属设施无损坏、乙方结清所有应缴费用（含租金、水电费、违约金等）后，甲方于 10 日内无息退还押金。若房屋或设施有损坏，甲方有权从押金中扣除维修费用，不足部分有权向乙方追偿。</label>
                </div>
            </div>
        </div>

        <!-- 第四条 相关费用承担 -->
        <div class="section">
            <h2>第四条 相关费用承担</h2>
            <div class="form-group">
                <div class="inline-input-group">
                    <p>1. 租赁期间，乙方承担该房屋的水费、电费、燃气费、物业管理费、宽带费、有线电视费、垃圾清运费等所有因使用房屋产生的费用，乙方应按时足额缴纳，不得拖欠。电每度 0.7 元，底数</p>
                    <input type="number" id="electric-base" placeholder="0" class="inline-input" style="min-width: 60px !important;">
                    <label>度，公区电耗分摊0.5元/度，水每方 5 元，底数</label>
                    <input type="number" id="water-base" placeholder="0" class="inline-input" style="min-width: 60px !important;">
                    <label>方（不足1方按1方算）</label>
                </div>
            </div>
            <p>2. 乙方应合理使用房屋设施，不得向下水道丢弃易堵塞物品，因乙方使用不当造成下水道堵塞或其他设施损坏的，乙方需承担疏通、维修费用及因此给甲方造成的全部损失。</p>
        </div>

        <!-- 第五条 房屋使用及维护 -->
        <div class="section">
            <h2>第五条 房屋使用及维护</h2>
            <p>1. 乙方应爱护房屋及附属设施，不得擅自拆改、变动房屋结构，不得损坏门窗、墙面、地面、家电、家具等设施。若因乙方使用不当或故意造成损坏，乙方应在甲方通知后 3 日内修复或承担维修费用，逾期未修复的，甲方有权自行维修，费用由乙方承担，同时乙方应支付维修费用 20% 的违约金。</p>
            <p>2. 乙方不得擅自增设、改装电器设备，若确需增设，应事先征得甲方书面同意，且不得改变房屋原有电路、水路布局，否则造成的安全事故及财产损失由乙方承担全部责任。</p>
            <p>3. 租赁期间，甲方有权定期（每月不超过 1 次）对房屋进行安全检查及设施维护，乙方应予以配合，不得无故拒绝。甲方检查时若发现乙方存在违规使用房屋或损坏设施的情况，有权要求乙方立即整改。</p>
            <p>4. 租赁期间，严禁在室内为电动车及电池充电，违规导致的一切后果由承租方自行承担。若承租方利用该房屋从事非法经营或其他违法活动，出租方有权立即无条件收回房屋，已收取的租金及押金不予退还；造成出租方损失的，承租方需按实际损失金额予以赔偿。</p>
            <p>5. 乙方须严格遵守居住所在地的居规民约，并按照当地街道办事处、公安机关等相关部门要求，及时办理各项法定手续及证件（包括但不限于莞 e 申报）。因未履行相关义务导致的法律责任及后果，均由乙方自行承担。</p>
        </div>

        <!-- 第六条 违约责任 -->
        <div class="section">
            <h2>第六条 违约责任</h2>
            <p>1. 乙方逾期支付租金的，每逾期一日，按应付未付租金的 1% 向甲方支付违约金；逾期超过 7 日的，甲方有权单方面解除合同，收回房屋，押金不予退还，同时乙方应支付相当于 1 个月租金的违约金，若违约金不足以弥补甲方损失（含空置期租金、中介费等），乙方应另行赔偿。</p>
            <p>2. 乙方违反本合同第一条第 2 款约定，擅自改变房屋用途、转租、转借、分租的，甲方有权立即解除合同，收回房屋，押金不予退还，乙方应支付相当于 2 个月租金的违约金，同时甲方有权要求乙方清退第三方，产生的费用由乙方承担。</p>
            <p>3. 乙方未按约定时间腾空房屋的，除按本合同第二条第 2 款支付占用费外，还应支付相当于 1 个月租金的违约金，若造成甲方其他损失（如后续租客无法入住的违约金），乙方应一并赔偿。</p>
            <p>4. 乙方损坏房屋结构或附属设施且拒不承担维修费用的，甲方有权从押金中扣除，不足部分有权追偿，同时乙方应支付维修费用等额的违约金。</p>
            <p>5. 因乙方原因导致房屋产生安全事故（如火灾、漏水等），造成甲方或第三方财产损失、人身伤害的，由乙方承担全部赔偿责任，甲方有权解除合同，押金不予退还。</p>
        </div>

        <!-- 第七条 合同解除及终止 -->
        <div class="section">
            <h2>第七条 合同解除及终止</h2>
            <p>1. 经甲方同意，乙方可提前解除合同，但应提前 30 日通知甲方，且押金不予退还，同时乙方应支付相当于 1 个月租金的违约金，甲方有权要求乙方结清所有费用并保持房屋及设施完好。</p>
            <p>2. 因不可抗力（如地震、拆迁等）导致合同无法履行的，双方互不承担违约责任，租金按实际租赁天数结算，押金无息退还，但乙方应配合甲方办理相关手续。</p>
            <p>3. 甲方因自身需要（如出售、自住等）需提前解除合同的，应提前 30 日通知乙方，押金无息退还，甲方无需支付违约金，但应退还乙方已支付的未实际租赁期间的租金。</p>
            <p>4. 合同期满退房时，乙方须结清全部费用，并完成房屋清洁。同时，每间房屋需缴纳 100 元卫生消毒费；若未履行清洁义务，需额外支付 100 元 / 间清洁费用。上述款项未结清或未按要求执行，甲方有权不予退还押金。乙方应于退房当日 12:00 前完成搬离，逾期将按临时住宿标准另行计费。</p>
        </div>

        <!-- 第八条 其他约定 -->
        <div class="section">
            <h2>第八条 其他约定</h2>
            <p>1. 乙方入住时应核对《房屋及附属设施交接清单》，签字确认后视为对房屋现状及设施的认可；租赁期满交接时，应按清单恢复原状（自然损耗除外）。</p>
            <p>2. 乙方不得在房屋内存放易燃易爆、有毒有害等危险物品，不得从事违法犯罪活动，否则甲方有权立即解除合同，押金不予退还，同时追究乙方法律责任。</p>
            <p>3. 本合同未尽事宜，由双方协商补充，补充协议与本合同具有同等法律效力；协商不成的，提交房屋所在地人民法院诉讼解决。</p>
            <p>4. 本合同一式两份，甲乙双方各执一份，自签字（或盖章）之日起生效。</p>
            <p>5. 为了大家共同安全,乙方来客须在当日 23 点前离开公寓,如需留宿须到管理处登记,乙方并承担留宿后果</p>
            <p>6. 租赁期间，乙方及共同居住人、访客不得在租赁房屋内饲养、寄养任何宠物（包括但不限于犬类、猫类、鸟类等各类动物），也不得携带宠物进入房屋，否则乙方需在 3-7 日内整改并支付月租金 50%-100% 的违约金，造成房屋损坏或第三方损失的由乙方全额赔偿，情节严重的甲方有权解除合同、没收押金并追偿全部损失</p>
            <p>7. 租赁期内，承租人作为房屋实际管理人，须严格履行安全管理义务，切实做好防火、防盗、防触电等安全防范工作，不得从事任何危及人身安全的活动。租赁房屋内发生的一切安全事故，包括但不限于因高空坠物、水电煤气使用不当、意外摔倒等导致承租人及其同住人员的人身伤害，均由承租人自行承担全部责任，出租人不承担任何法律及经济责任。</p>
        </div>

        <!-- 附件一：房屋及附属设施交接清单 -->
        <div class="section">
            <h2>附件一：《房屋及附属设施交接清单》</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="item1" checked>
                <label for="item1">空调</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item2" checked>
                <label for="item2">冰箱</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item3" checked>
                <label for="item3">油烟机</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item4" checked>
                <label for="item4">洗衣机</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item5" checked>
                <label for="item5">热水器</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item6" checked>
                <label for="item6">路由器</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item7" checked>
                <label for="item7">床</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item8" checked>
                <label for="item8">沙发</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item9" checked>
                <label for="item9">门窗</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item10" checked>
                <label for="item10">墙面</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item11" checked>
                <label for="item11">地面</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item12">
                <label for="item12">茶几</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item13">
                <label for="item13">衣柜</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="item14">
                <label for="item14">窗帘</label>
            </div>
            <div class="form-group">
                <label>其他设施：</label>
                <input type="text" id="other-items" placeholder="请输入其他设施名称">
            </div>
        </div>

        <!-- 签名区域 - 重构结构 -->
        <div class="signature-container">
            <h2>签字确认</h2>
            <div class="signature-row">
                <!-- 甲方签名区域 -->
                <div class="signature-col">
                    <label>甲方（签字 / 盖章）：</label>
                    <!-- 签名板容器，增加提示文字 -->
                    <div style="position: relative;">
                        <canvas id="signature-pad-a" class="signature-pad"></canvas>
                        <div class="signature-hint" id="hint-a">点击并拖动鼠标/手指签名</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-warning" onclick="clearSignature('a', event)">清除甲方签名</button>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>日期：</label>
                        <input type="date" id="sign-date-a">
                    </div>
                </div>
                <!-- 乙方签名区域 -->
                <div class="signature-col">
                    <label>乙方（签字 / 盖章）：</label>
                    <div style="position: relative;">
                        <canvas id="signature-pad-b" class="signature-pad"></canvas>
                        <div class="signature-hint" id="hint-b">点击并拖动鼠标/手指签名</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button type="button" class="btn btn-warning" onclick="clearSignature('b', event)">清除乙方签名</button>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>日期：</label>
                        <input type="date" id="sign-date-b">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能按钮 -->
    <div class="btn-group">
        <button class="btn btn-primary" id="save-image-btn">保存为图片</button>
        <button class="btn btn-success" id="save-pdf-btn">保存为PDF</button>
        <button class="btn btn-warning" id="print-btn">打印合同</button>
    </div>

    <script>
        // 全局变量管理
        let isImageSaving = false;
        // 签名实例对象，存储甲乙双方签名状态
        const signatureState = {
            a: {
                canvas: null,
                ctx: null,
                isDrawing: false,
                lastX: 0,
                lastY: 0,
                hasSignature: false
            },
            b: {
                canvas: null,
                ctx: null,
                isDrawing: false,
                lastX: 0,
                lastY: 0,
                hasSignature: false
            }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化日期默认值
            initDefaultDates();
            
            // 初始化签名板（核心修复）
            initSignaturePad('a');
            initSignaturePad('b');

            // 绑定按钮事件
            bindButtonEvents();

            // 初始化必填字段数组
            window.requiredFields = [
                'partyA-name', 'partyA-tel', 'partyB-name', 'partyB-id', 
                'partyB-tel', 'apartment-name', 'room-number', 'monthly-rent',
                'deposit', 'lease-start', 'lease-end'
            ];

            // 初始化输入框事件
            initInputEvents();
        });

        /**
         * 初始化默认日期
         */
        function initDefaultDates() {
            const today = new Date();
            const sixMonthsLater = new Date();
            sixMonthsLater.setMonth(today.getMonth() + 6);

            // 格式化日期为YYYY-MM-DD
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };

            const startDateVal = formatDate(today);
            const endDateVal = formatDate(sixMonthsLater);
            
            // 设置租赁日期
            document.getElementById('lease-start').value = startDateVal;
            document.getElementById('lease-end').value = endDateVal;
            
            // 设置签名日期
            document.getElementById('sign-date-a').value = startDateVal;
            document.getElementById('sign-date-b').value = startDateVal;

            // 计算租赁月数
            const start = new Date(startDateVal);
            const end = new Date(endDateVal);
            const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
            document.getElementById('lease-months').value = months;

            // 监听租赁日期变化，自动计算月数
            const dateInputs = document.querySelectorAll('.lease-date');
            dateInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const start = new Date(document.getElementById('lease-start').value);
                    const end = new Date(document.getElementById('lease-end').value);
                    if (start && end && end > start) {
                        const diffMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
                        document.getElementById('lease-months').value = diffMonths;
                    }
                });
            });
        }

        /**
         * 初始化签名板 - 核心修复函数
         * @param {string} prefix - 签名板标识（a:甲方，b:乙方）
         */
        function initSignaturePad(prefix) {
            try {
                // 获取画布元素
                const canvas = document.getElementById(`signature-pad-${prefix}`);
                if (!canvas) {
                    console.error(`签名板${prefix}未找到`);
                    return;
                }

                // 获取画布上下文
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error(`无法获取签名板${prefix}的2D上下文`);
                    return;
                }

                // 存储签名板实例
                signatureState[prefix].canvas = canvas;
                signatureState[prefix].ctx = ctx;

                // 修复画布分辨率（适配高清屏）
                fixCanvasResolution(prefix);

                // 解绑已有事件（防止重复绑定）
                unbindSignatureEvents(prefix);

                // 绑定签名事件（鼠标+触摸）
                bindSignatureEvents(prefix);

                // 初始化画布状态
                resetSignatureCanvas(prefix);

                console.log(`签名板${prefix}初始化完成`);
            } catch (error) {
                console.error(`签名板${prefix}初始化失败：`, error);
            }
        }

        /**
         * 修复画布分辨率 - 解决模糊问题
         * @param {string} prefix - 签名板标识
         */
        function fixCanvasResolution(prefix) {
            const canvas = signatureState[prefix].canvas;
            const ctx = signatureState[prefix].ctx;

            // 获取画布显示尺寸
            const rect = canvas.getBoundingClientRect();
            
            // 保存当前绘制内容
            const tempImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // 设置画布实际尺寸（乘以设备像素比）
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // 缩放上下文
            ctx.scale(dpr, dpr);
            
            // 恢复绘制内容
            if (tempImageData) {
                ctx.putImageData(tempImageData, 0, 0);
            }
        }

        /**
         * 解绑签名事件
         * @param {string} prefix - 签名板标识
         */
        function unbindSignatureEvents(prefix) {
            const canvas = signatureState[prefix].canvas;
            if (!canvas) return;

            // 解绑鼠标事件
            canvas.removeEventListener('mousedown', (e) => handleSignatureStart(e, prefix));
            canvas.removeEventListener('mousemove', (e) => handleSignatureMove(e, prefix));
            canvas.removeEventListener('mouseup', (e) => handleSignatureEnd(e, prefix));
            canvas.removeEventListener('mouseout', (e) => handleSignatureEnd(e, prefix));

            // 解绑触摸事件
            canvas.removeEventListener('touchstart', (e) => handleTouchStart(e, prefix));
            canvas.removeEventListener('touchmove', (e) => handleTouchMove(e, prefix));
            canvas.removeEventListener('touchend', (e) => handleTouchEnd(e, prefix));
            canvas.removeEventListener('touchcancel', (e) => handleTouchEnd(e, prefix));
        }

        /**
         * 绑定签名事件（鼠标+触摸）
         * @param {string} prefix - 签名板标识
         */
        function bindSignatureEvents(prefix) {
            const canvas = signatureState[prefix].canvas;
            if (!canvas) return;

            // 鼠标事件
            canvas.addEventListener('mousedown', (e) => handleSignatureStart(e, prefix));
            canvas.addEventListener('mousemove', (e) => handleSignatureMove(e, prefix));
            canvas.addEventListener('mouseup', (e) => handleSignatureEnd(e, prefix));
            canvas.addEventListener('mouseout', (e) => handleSignatureEnd(e, prefix));

            // 触摸事件（移动端支持）
            canvas.addEventListener('touchstart', (e) => handleTouchStart(e, prefix));
            canvas.addEventListener('touchmove', (e) => handleTouchMove(e, prefix));
            canvas.addEventListener('touchend', (e) => handleTouchEnd(e, prefix));
            canvas.addEventListener('touchcancel', (e) => handleTouchEnd(e, prefix));
        }

        /**
         * 处理签名开始（鼠标）
         * @param {MouseEvent} e - 鼠标事件
         * @param {string} prefix - 签名板标识
         */
        function handleSignatureStart(e, prefix) {
            e.preventDefault();
            const state = signatureState[prefix];
            if (!state.ctx) return;

            // 获取画布坐标
            const { x, y } = getCanvasCoordinates(e, state.canvas);
            
            // 更新签名状态
            state.isDrawing = true;
            state.lastX = x;
            state.lastY = y;

            // 绘制起始点（解决点按无反应问题）
            state.ctx.beginPath();
            state.ctx.arc(x, y, 1, 0, 2 * Math.PI);
            state.ctx.fillStyle = '#000';
            state.ctx.fill();

            // 隐藏提示文字
            document.getElementById(`hint-${prefix}`).style.display = 'none';
        }

        /**
         * 处理签名绘制（鼠标）
         * @param {MouseEvent} e - 鼠标事件
         * @param {string} prefix - 签名板标识
         */
        function handleSignatureMove(e, prefix) {
            e.preventDefault();
            const state = signatureState[prefix];
            if (!state.isDrawing || !state.ctx) return;

            // 获取画布坐标
            const { x, y } = getCanvasCoordinates(e, state.canvas);

            // 绘制线条
            state.ctx.beginPath();
            state.ctx.moveTo(state.lastX, state.lastY);
            state.ctx.lineTo(x, y);
            state.ctx.lineWidth = 2; // 线条宽度
            state.ctx.lineCap = 'round'; // 线条端点圆润
            state.ctx.lineJoin = 'round'; // 线条连接处圆润
            state.ctx.strokeStyle = '#000'; // 线条颜色
            state.ctx.stroke();

            // 更新坐标
            state.lastX = x;
            state.lastY = y;

            // 标记已有签名
            state.hasSignature = true;
        }

        /**
         * 处理签名结束（鼠标）
         * @param {MouseEvent} e - 鼠标事件
         * @param {string} prefix - 签名板标识
         */
        function handleSignatureEnd(e, prefix) {
            e.preventDefault();
            const state = signatureState[prefix];
            state.isDrawing = false;
        }

        /**
         * 处理触摸开始（移动端）
         * @param {TouchEvent} e - 触摸事件
         * @param {string} prefix - 签名板标识
         */
        function handleTouchStart(e, prefix) {
            e.preventDefault();
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                // 模拟鼠标事件
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true,
                    cancelable: true
                });
                signatureState[prefix].canvas.dispatchEvent(mouseEvent);
            }
        }

        /**
         * 处理触摸移动（移动端）
         * @param {TouchEvent} e - 触摸事件
         * @param {string} prefix - 签名板标识
         */
        function handleTouchMove(e, prefix) {
            e.preventDefault();
            if (e.touches.length > 0 && signatureState[prefix].isDrawing) {
                const touch = e.touches[0];
                // 模拟鼠标事件
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true,
                    cancelable: true
                });
                signatureState[prefix].canvas.dispatchEvent(mouseEvent);
            }
        }

        /**
         * 处理触摸结束（移动端）
         * @param {TouchEvent} e - 触摸事件
         * @param {string} prefix - 签名板标识
         */
        function handleTouchEnd(e, prefix) {
            e.preventDefault();
            // 模拟鼠标事件
            const mouseEvent = new MouseEvent('mouseup', {
                bubbles: true,
                cancelable: true
            });
            signatureState[prefix].canvas.dispatchEvent(mouseEvent);
        }

        /**
         * 获取画布坐标（修复坐标偏移）
         * @param {Event} e - 事件对象
         * @param {HTMLCanvasElement} canvas - 画布元素
         * @returns {Object} 相对画布的坐标 {x, y}
         */
        function getCanvasCoordinates(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // 计算相对坐标（适配缩放和偏移）
            return {
                x: (e.clientX - rect.left) / (rect.width / canvas.width) * (1 / dpr),
                y: (e.clientY - rect.top) / (rect.height / canvas.height) * (1 / dpr)
            };
        }

        /**
         * 重置签名画布
         * @param {string} prefix - 签名板标识
         */
        function resetSignatureCanvas(prefix) {
            const state = signatureState[prefix];
            if (!state.ctx || !state.canvas) return;

            const dpr = window.devicePixelRatio || 1;
            // 清除画布
            state.ctx.clearRect(
                0, 
                0, 
                state.canvas.width / dpr, 
                state.canvas.height / dpr
            );
            
            // 重置状态
            state.isDrawing = false;
            state.lastX = 0;
            state.lastY = 0;
            state.hasSignature = false;

            // 显示提示文字
            document.getElementById(`hint-${prefix}`).style.display = 'block';
        }

        /**
         * 清除签名（修复按钮事件问题）
         * @param {string} prefix - 签名板标识
         * @param {Event} event - 事件对象
         */
        function clearSignature(prefix, event) {
            // 阻止事件冒泡和默认行为（核心修复）
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            console.log(`清除签名${prefix}`);
            resetSignatureCanvas(prefix);
        }

        /**
         * 绑定功能按钮事件
         */
        function bindButtonEvents() {
            // 保存为图片
            document.getElementById('save-image-btn').addEventListener('click', function() {
                if (validateForm() && !isImageSaving) {
                    saveAsImage();
                }
            });

            // 保存为PDF
            document.getElementById('save-pdf-btn').addEventListener('click', function() {
                if (validateForm()) {
                    saveAsPDF();
                }
            });

            // 打印合同
            document.getElementById('print-btn').addEventListener('click', function() {
                if (validateForm()) {
                    window.print();
                }
            });

            // 窗口大小变化时重新调整签名板
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    fixCanvasResolution('a');
                    fixCanvasResolution('b');
                }, 300);
            });
        }

        /**
         * 保存为图片
         */
        function saveAsImage() {
            if (isImageSaving) return;

            try {
                isImageSaving = true;
                const saveBtn = document.getElementById('save-image-btn');
                const originalText = saveBtn.innerText;
                saveBtn.innerText = '保存中...';
                saveBtn.disabled = true;

                // 获取文件名
                const apartmentName = document.getElementById('apartment-name').value || '未知公寓';
                const roomNumber = document.getElementById('room-number').value || '未知房号';
                const startDate = document.getElementById('lease-start').value || '未知日期';
                const fileName = `${apartmentName}${roomNumber}_租赁合同_${startDate}`;

                // 配置html2canvas（确保签名正常渲染）
                html2canvas(document.getElementById('contract-content'), {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: false,
                    backgroundColor: '#fff',
                    windowWidth: document.getElementById('contract-content').offsetWidth,
                    windowHeight: document.getElementById('contract-content').offsetHeight,
                    // 修复输入框和签名板渲染
                    onclone: (clonedDoc) => {
                        // 处理输入框
                        const clonedInputs = clonedDoc.querySelectorAll('input, textarea');
                        clonedInputs.forEach(input => {
                            if (input.type === 'text' || input.type === 'tel' || input.type === 'number' || input.type === 'date' || input.tagName === 'TEXTAREA') {
                                input.setAttribute('value', input.value);
                            }
                            if (input.type === 'checkbox') {
                                input.checked = input.checked;
                            }
                            input.style.opacity = '1';
                            input.style.visibility = 'visible';
                        });

                        // 处理签名板（复制签名内容）
                        ['a', 'b'].forEach(prefix => {
                            const sourceCanvas = document.getElementById(`signature-pad-${prefix}`);
                            const targetCanvas = clonedDoc.getElementById(`signature-pad-${prefix}`);
                            if (sourceCanvas && targetCanvas) {
                                const targetCtx = targetCanvas.getContext('2d');
                                targetCtx.drawImage(sourceCanvas, 0, 0);
                                // 隐藏提示文字
                                const hint = clonedDoc.getElementById(`hint-${prefix}`);
                                if (hint) hint.style.display = 'none';
                            }
                        });
                    }
                }).then(canvas => {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.download = `${fileName}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);

                    // 触发下载
                    link.click();

                    // 清理资源
                    setTimeout(() => {
                        URL.revokeObjectURL(link.href);
                        isImageSaving = false;
                        saveBtn.innerText = originalText;
                        saveBtn.disabled = false;
                    }, 1000);
                }).catch(error => {
                    console.error('保存图片失败：', error);
                    alert('保存图片失败，请重试！');
                    isImageSaving = false;
                    saveBtn.innerText = originalText;
                    saveBtn.disabled = false;
                });
            } catch (error) {
                console.error('保存图片异常：', error);
                alert('保存图片异常，请重试！');
                isImageSaving = false;
                const saveBtn = document.getElementById('save-image-btn');
                saveBtn.innerText = '保存为图片';
                saveBtn.disabled = false;
            }
        }

        /**
         * 保存为PDF
         */
        function saveAsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                // 获取文件名
                const apartmentName = document.getElementById('apartment-name').value || '未知公寓';
                const roomNumber = document.getElementById('room-number').value || '未知房号';
                const startDate = document.getElementById('lease-start').value || '未知日期';
                const fileName = `${apartmentName}${roomNumber}_租赁合同_${startDate}`;

                const saveBtn = document.getElementById('save-pdf-btn');
                const originalText = saveBtn.innerText;
                saveBtn.innerText = '生成中...';
                saveBtn.disabled = true;

                // 配置html2canvas
                html2canvas(document.getElementById('contract-content'), {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: false,
                    backgroundColor: '#fff',
                    windowWidth: document.getElementById('contract-content').offsetWidth,
                    windowHeight: document.getElementById('contract-content').offsetHeight,
                    onclone: (clonedDoc) => {
                        // 处理输入框
                        const clonedInputs = clonedDoc.querySelectorAll('input, textarea');
                        clonedInputs.forEach(input => {
                            if (input.type === 'text' || input.type === 'tel' || input.type === 'number' || input.type === 'date' || input.tagName === 'TEXTAREA') {
                                input.setAttribute('value', input.value);
                            }
                            if (input.type === 'checkbox') {
                                input.checked = input.checked;
                            }
                            input.style.opacity = '1';
                            input.style.visibility = 'visible';
                        });

                        // 处理签名板
                        ['a', 'b'].forEach(prefix => {
                            const sourceCanvas = document.getElementById(`signature-pad-${prefix}`);
                            const targetCanvas = clonedDoc.getElementById(`signature-pad-${prefix}`);
                            if (sourceCanvas && targetCanvas) {
                                const targetCtx = targetCanvas.getContext('2d');
                                targetCtx.drawImage(sourceCanvas, 0, 0);
                                const hint = clonedDoc.getElementById(`hint-${prefix}`);
                                if (hint) hint.style.display = 'none';
                            }
                        });
                    }
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const imgWidth = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // 添加图片到PDF
                    doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    doc.save(`${fileName}.pdf`);

                    // 恢复按钮状态
                    setTimeout(() => {
                        saveBtn.innerText = originalText;
                        saveBtn.disabled = false;
                    }, 800);
                }).catch(error => {
                    console.error('生成PDF失败：', error);
                    alert('生成PDF失败，请重试！');
                    saveBtn.innerText = originalText;
                    saveBtn.disabled = false;
                });
            } catch (error) {
                console.error('生成PDF异常：', error);
                alert('生成PDF异常，请重试！');
                const saveBtn = document.getElementById('save-pdf-btn');
                saveBtn.innerText = '保存为PDF';
                saveBtn.disabled = false;
            }
        }

        /**
         * 表单验证
         * @returns {boolean} 验证结果
         */
        function validateForm() {
            const requiredFields = window.requiredFields || [];
            let isValid = true;

            requiredFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (!input) return;

                const value = input.value.trim();
                if (!value) {
                    input.style.borderColor = 'red';
                    input.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.2)';
                    isValid = false;
                } else {
                    input.style.borderColor = '#ddd';
                    input.style.boxShadow = 'none';
                }
            });

            // 验证签名（可选）
            if (isValid) {
                const hasASign = signatureState.a.hasSignature;
                const hasBSign = signatureState.b.hasSignature;
                if (!hasASign || !hasBSign) {
                    const missing = [];
                    if (!hasASign) missing.push('甲方');
                    if (!hasBSign) missing.push('乙方');
                    alert(`${missing.join('和')}签名尚未完成，请完成签名后再操作！`);
                    isValid = false;

                    // 滚动到未完成的签名板
                    if (!hasASign) {
                        document.getElementById('signature-pad-a').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else if (!hasBSign) {
                        document.getElementById('signature-pad-b').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }

            if (!isValid && !requiredFields.some(id => !document.getElementById(id).value.trim())) {
                // 仅签名未完成的情况已处理，此处无需额外提示
            } else if (!isValid) {
                alert('请填写所有必填字段（红色边框为未填写项）！');
                // 滚动到第一个错误字段
                const firstError = document.querySelector('input[style*="border-color: red"], textarea[style*="border-color: red"]');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }

            return isValid;
        }

        /**
         * 初始化输入框事件
         */
        function initInputEvents() {
            const inputFields = document.querySelectorAll('input, textarea');
            inputFields.forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#3498db';
                    this.style.boxShadow = '0 0 0 2px rgba(52, 152, 219, 0.2)';
                });

                input.addEventListener('blur', function() {
                    const fieldId = this.id;
                    const isRequired = window.requiredFields && window.requiredFields.includes(fieldId);
                    const hasValue = this.value.trim() !== '';

                    if (isRequired && !hasValue) {
                        this.style.borderColor = 'red';
                        this.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.2)';
                    } else {
                        this.style.borderColor = '#ddd';
                        this.style.boxShadow = 'none';
                    }
                });
            });
        }

        /**
         * 自动填充示例数据（测试用）
         */
        function fillSampleData() {
            document.getElementById('partyA-name').value = '张三';
            document.getElementById('partyA-tel').value = '13800138000';
            document.getElementById('partyB-name').value = '李四';
            document.getElementById('partyB-id').value = '440101199001011234';
            document.getElementById('partyB-tel').value = '13900139000';
            document.getElementById('partyB-emergency').value = '王五 13700137000';
            document.getElementById('partyB-residents').value = '李四（本人）';
            document.getElementById('apartment-name').value = '阳光花园';
            document.getElementById('room-number').value = '3栋502';
            document.getElementById('monthly-rent').value = '3500';
            document.getElementById('management-fee').value = '150';
            document.getElementById('deposit').value = '7000';
            document.getElementById('card-deposit').value = '50';
            document.getElementById('remote-deposit').value = '30';
            document.getElementById('electric-base').value = '1200';
            document.getElementById('water-base').value = '350';
            document.getElementById('other-items').value = '燃气灶、微波炉';

            // 自动填充示例签名
            setTimeout(() => {
                drawSampleSignature('a');
                drawSampleSignature('b');
            }, 500);
        }

        /**
         * 绘制示例签名（测试用）
         * @param {string} prefix - 签名板标识
         */
        function drawSampleSignature(prefix) {
            const state = signatureState[prefix];
            if (!state.ctx || !state.canvas) return;

            // 隐藏提示文字
            document.getElementById(`hint-${prefix}`).style.display = 'none';

            // 绘制示例签名
            state.ctx.beginPath();
            state.ctx.moveTo(50, 80);
            state.ctx.bezierCurveTo(80, 40, 120, 120, 150, 80);
            state.ctx.bezierCurveTo(180, 40, 220, 120, 250, 80);
            state.ctx.lineWidth = 2;
            state.ctx.lineCap = 'round';
            state.ctx.lineJoin = 'round';
            state.ctx.strokeStyle = '#000';
            state.ctx.stroke();

            // 标记已有签名
            state.hasSignature = true;
        }

        /**
         * 快捷键支持（F5填充示例数据）
         */
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5' && !e.ctrlKey && !e.shiftKey) {
                e.preventDefault();
                fillSampleData();
                alert('已填充示例数据和签名！');
            }
        });
    </script>
</body>
</html>
